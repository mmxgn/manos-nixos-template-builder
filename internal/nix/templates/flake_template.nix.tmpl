{
  description = "{{ .Description }}";

  inputs = {
    nixpkgs.url = "{{ .NixpkgsURL }}";
    flake-utils.url = "github:numtide/flake-utils";
  };

  outputs = { self, nixpkgs, flake-utils }:
    flake-utils.lib.eachDefaultSystem (system:
      let
        pkgs = import nixpkgs {
          inherit system;
          config.allowUnfree = true;  # Required for CUDA and other unfree packages
        };

        pythonEnv = pkgs.{{ .PythonVersion }}.withPackages (ps: with ps; [
          {{- range .PythonPackages }}
          {{ . }}
          {{- end }}
          {{- range .PyPIPackages }}

          # PyPI: {{ .Name }}{{ if .Resolved }} {{ .Version }}{{ end }}
          (ps.buildPythonPackage rec {
            pname = "{{ .Name }}";
            {{- if .Resolved }}
            version = "{{ .Version }}";
            {{- else }}
            version = ""; # TODO: set version, e.g. "1.0.0"
            {{- end }}
            pyproject = true;
            src = ps.fetchPypi {
              inherit pname version;
              hash = {{ .HashExpr }};{{ if not .Resolved }} # run 'nix develop' → paste hash from the error{{ end }}
            };
            build-system = [ ps.setuptools ];
            doCheck = false;
          })
          {{- end }}
        ]);
      in
      {
        {{- if .UseFHS }}
        devShells.default = (pkgs.buildFHSEnv {
          name = "dev-env";
          targetPkgs = pkgs: [
            pythonEnv
            {{- range .SystemPackages }}
            pkgs.{{ . }}
            {{- end }}
          ];

          profile = ''
            echo "Development environment loaded."
            {{- if .EnvVars }}
            # Environment variables
            {{- range .EnvVars }}
            export {{ . }}=""
            {{- end }}
            {{- end }}
          '';
        }).env;
        {{- else }}
        devShells.default = pkgs.mkShell {
          buildInputs = [
            pythonEnv
            {{- range .SystemPackages }}
            pkgs.{{ . }}
            {{- end }}
          ];
          {{- if .EnvVars }}

          # Environment variables (empty by default — fill in as needed)
          {{- range .EnvVars }}
          {{ . }} = "";
          {{- end }}
          {{- end }}

          shellHook = ''
            echo "Development environment loaded."
          '';
        };
        {{- end }}

        # Example package build (uncomment and adapt as needed):
        # packages.default = pkgs.{{ .PythonVersion }}.pkgs.buildPythonPackage rec {
        #   pname = "my-app";
        #   version = "0.1.0";
        #   src = ./.;
        # };
      }
    );
}
